<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>„ÇΩ„Ç∑„É£„Ç≤È¢®„Ç¨„ÉÅ„É£ÔºàÂÆåÊàêÁâàÔºâ</title>
    <style>
        body { background: #222; color: white; font-family: sans-serif; margin: 0; overflow: hidden; text-align: center; }
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .active { display: flex; }

        button { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 50px; border: none; font-weight: bold; transition: 0.2s; background: white; color: #333; z-index: 10; }
        button:hover { transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .btn-group { display: flex; gap: 20px; margin-top: 20px; }

        #lobby-screen { background: radial-gradient(circle, #0042A9, #000); }

        /* --- Âè¨ÂñöÂæÖÊ©üÁîªÈù¢ (Gate) --- */
        #gate-screen { background: black; cursor: pointer; }

        .gate-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('./background/R.jpeg'); /* Áõ∏ÂØæ„Éë„Çπ„Å´‰øÆÊ≠£ */
            background-size: cover; background-position: center;
            z-index: 1; transform: scale(1);
            transition: background-image 0.3s ease;
        }

        .gate-bg.sr-confirmed { background-image: url('./background/SR.jpeg'); }
        .gate-bg.ssr-confirmed { background-image: url('./background/SSR.jpeg'); box-shadow: inset 0 0 100px gold; }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºö„Çø„É°„Å¶„Åã„ÇâÁ™Å„Å£Ëæº„ÇÄ */
        .gate-zoom-animation { animation: gateAction 2.2s cubic-bezier(0.45, 0, 0.55, 1) forwards; }
        @keyframes gateAction {
            0% { transform: scale(1); filter: brightness(1); }
            30% { transform: scale(0.9); filter: brightness(0.8); }
            100% { transform: scale(15); filter: brightness(5) blur(10px); opacity: 0; }
        }

        .gate-text { position: relative; z-index: 2; font-size: 32px; font-weight: bold; letter-spacing: 5px; animation: pulse 2s infinite; text-shadow: 0 0 20px #00bcd4; }
        @keyframes pulse { 0%, 100% { opacity: 0.3; transform: scale(0.95); } 50% { opacity: 1; transform: scale(1.05); } }
        .fade-out { animation: textFade 0.5s forwards; }
        @keyframes textFade { to { opacity: 0; transform: scale(0.8); } }

        /* --- „Ç™„Éº„ÉñÊºîÂá∫ --- */
        .orb-container { position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; z-index: 3; }
        .orb { position: absolute; width: 10px; height: 10px; border-radius: 50%; filter: blur(2px); opacity: 0; }

        /* --- ÁµêÊûúÁîªÈù¢„Éª„Ç´„Éº„ÉâÈñ¢ÈÄ£ --- */
        #result-screen { background: #111; }
        #result-container { display: grid; gap: 15px; margin-bottom: 30px; min-height: 320px; align-items: center; justify-items: center; }
        .card-wrapper { width: 100px; height: 140px; perspective: 600px; opacity: 0; transform: translateY(40px); }
        .show-wrapper { animation: wrapperAppear 0.5s forwards; }
        @keyframes wrapperAppear { to { opacity: 1; transform: translateY(0); } }
        .card { width: 100%; height: 100%; position: relative; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .is-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card-back { background: #444; border: 2px solid #666; background-image: repeating-linear-gradient(45deg, #333 0, #333 10px, #444 10px, #444 20px); }
        .card-front { transform: rotateY(180deg); background: #333; }
        .back-sr { border: 2px solid #f5576c; box-shadow: 0 0 15px #f5576c; }
        .back-ssr { border: 2px solid gold; box-shadow: 0 0 20px gold; animation: goldPulse 1s infinite alternate; }
        @keyframes goldPulse { from { box-shadow: 0 0 10px gold; } to { box-shadow: 0 0 25px gold; } }
        .ssr { border: 3px solid gold; box-shadow: 0 0 25px gold; background: #444422; }
        .sr { border: 2px solid #f5576c; box-shadow: 0 0 15px #f5576c; background: #442222; }

        /* ÁâπÊÆäÊºîÂá∫„Éª„Éï„É©„ÉÉ„Ç∑„É• */
        #flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; z-index: 2000; pointer-events: none; }
        .do-flash { animation: flashAnim 0.5s ease-out; }
        @keyframes flashAnim { 0% { opacity: 1; } 100% { opacity: 0; } }

        #new-character-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .huge-icon { font-size: 150px; filter: drop-shadow(0 0 20px gold); }
        .super-shake { animation: superShake 0.4s infinite; }
        @keyframes superShake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-3px, -2px); } 100% { transform: translate(2px, 2px); } }
        
        #single-card-display { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body id="main-body">

<div id="new-character-overlay" onclick="resumeGacha()"></div>

<div id="lobby-screen" class="screen active">
    <h1>‰ºùË™¨„ÅÆÂè¨Âñö</h1>
    <div class="btn-group">
        <button onclick="prepareGacha(1)">1ÂõûÂè¨Âñö</button>
        <button onclick="prepareGacha(10)" style="background: #ffaa00; color: white;">10ÂõûÂè¨Âñö</button>
    </div>
</div>

<div id="gate-screen" class="screen" onclick="executeGacha()">
    <div class="gate-bg" id="gate-bg"></div>
    <div class="gate-text">- TOUCH TO SUMMON -</div>
</div>

<div id="flash-overlay"></div>
<div id="result-screen" class="screen">
    <div id="result-container"></div>
    <div class="btn-group">
        <button onclick="toLobby()">Êàª„Çã</button>
        <button id="retry-btn" onclick="prepareGacha(lastCount)" style="background: #ffaa00; color: white;">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
    </div>
</div>

<div id="single-card-display" onclick="closeSingleCardDisplay()">
    <div class="single-card-inner r" id="detail-inner">
        <div id="card-detail-icon" style="font-size: 80px;"></div>
        <div id="card-detail-rarity" style="font-size: 24px; font-weight: bold; margin-top: 10px;"></div>
        <div id="card-detail-name" style="font-size: 18px; color: #ccc;"></div>
    </div>
</div>

<script>
    const resultContainer = document.getElementById('result-container');
    const flashOverlay = document.getElementById('flash-overlay');
    const newOverlay = document.getElementById('new-character-overlay');
    const gateBg = document.getElementById('gate-bg');
    const body = document.getElementById('main-body');

    let lastCount = 1;
    let ownedChars = new Set(); 
    let resolveGachaWait = null;
    let canClickToNext = false; 

    const charData = {
        ssr: [
            { id: "dragon", icon: "üêâ", name: "ÁÇé„ÅÆÁ´úÁéã", quote: "Êàë„ÅåÁÑî„Å´ÁÑº„ÅëÁÑ¶„Åí„Çã„Åå„ÅÑ„ÅÑÔºÅ" },
            { id: "queen", icon: "üë∏", name: "ÂÖâ„ÅÆÂ•≥Áéã", quote: "Â∏åÊúõ„ÅÆÂÖâ„Çà„ÄÅ‰∏ñÁïå„ÇíÁÖß„Çâ„Åó„Å¶„ÄÇ" },
            { id: "diamond", icon: "üíé", name: "ËíºÁ©π„ÅÆÂÆùÁè†", quote: "„Åì„ÅÆËºù„Åç„ÄÅË™∞„Å´„ÇÇÊ∏°„Åï„Å™„ÅÑ„ÄÇ" }
        ],
        sr: [
            { id: "sword", icon: "‚öîÔ∏è", name: "ÂãáËÄÖ„ÅÆÂâ£", quote: "„Åì„ÅÆ‰∏ÄÊíÉ„ÅßÊ±∫„ÇÅ„ÇãÔºÅ" },
            { id: "shield", icon: "üõ°Ô∏è", name: "ÂÆàË≠∑ËÄÖ„ÅÆÁõæ", quote: "„Åì„Åì„ÅØ‰∏ÄÊ≠©„ÇÇÈÄö„Åï„Å™„ÅÑ„Åú„ÄÇ" },
            { id: "fire", icon: "üî•", name: "ÁÅºÁÜ±„ÅÆÁ≤æÈúä", quote: "„ÇÇ„Å£„Å®ÁÜ±„Åè„Åó„Å¶„ÇÑ„Çã„ÇàÔºÅ" }
        ],
        r: [
            { id: "plant", icon: "üåø", name: "ËçâÂéü„ÅÆÁï™‰∫∫", quote: "È¢®„ÅåÂêπ„ÅÑ„Å¶„ÅÑ„Çã„Å≠„ÄÇ" },
            { id: "wood", icon: "ü™µ", name: "Ê£Æ„ÅÆÊú®„Åì„Çä", quote: "ËâØ„ÅÑÊùêÊú®„ÅåÊé°„Çå„Åù„ÅÜ„Å†„ÄÇ" },
            { id: "bone", icon: "ü¶¥", name: "ÂΩ∑Âæ®„ÅÜÈ≠Ç", quote: "ÁßÅ„ÅØ‚Ä¶„Å©„Åì„Å´„ÅÑ„Çã„ÅÆ„Å†‚Ä¶" }
        ]
    };

    function prepareGacha(count) {
        lastCount = count;
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('gate-screen').classList.add('active');
        gateBg.classList.remove('gate-zoom-animation', 'sr-confirmed', 'ssr-confirmed');
        const gateText = document.querySelector('.gate-text');
        gateText.classList.remove('fade-out');
        const container = document.querySelector('.orb-container');
        if(container) container.remove();
    }

    function generateResults(count) {
        const results = [];
        for (let i = 0; i < count; i++) {
            const rand = Math.random();
            let rarity = rand < 0.05 ? "ssr" : (rand < 0.25 ? "sr" : "r");
            const pool = charData[rarity];
            const char = pool[Math.floor(Math.random() * pool.length)];
            const isNew = !ownedChars.has(char.id);
            if (isNew) ownedChars.add(char.id);
            results.push({ ...char, rarity, isNew });
        }
        return results;
    }

    async function executeGacha() {
        if (gateBg.classList.contains('gate-zoom-animation')) return;

        const results = generateResults(lastCount);
        const hasSSR = results.some(item => item.rarity === "ssr");
        const hasSR = results.some(item => item.rarity === "sr");

        if (hasSSR) { gateBg.classList.add('ssr-confirmed'); createOrbs(true); }
        else if (hasSR) { gateBg.classList.add('sr-confirmed'); createOrbs(false); }

        document.querySelector('.gate-text').classList.add('fade-out');
        gateBg.classList.add('gate-zoom-animation');
        
        await new Promise(r => setTimeout(r, 1200));
        flashOverlay.classList.add('do-flash');
        setTimeout(() => flashOverlay.classList.remove('do-flash'), 500);
        
        await new Promise(r => setTimeout(r, 800));
        renderCards(results);
    }

    function createOrbs(isSSR) {
        const container = document.createElement('div');
        container.className = 'orb-container';
        document.getElementById('gate-screen').appendChild(container);
        const count = isSSR ? 40 : 15;
        const color = isSSR ? 'gold' : '#00bcd4';
        for (let i = 0; i < count; i++) {
            const orb = document.createElement('div');
            orb.className = 'orb';
            orb.style.background = color;
            orb.style.boxShadow = `0 0 10px ${color}`;
            const angle = Math.random() * Math.PI * 2;
            const distance = 400 + Math.random() * 400;
            const tx = Math.cos(angle) * distance;
            const ty = Math.sin(angle) * distance;
            orb.style.left = '50%'; orb.style.top = '50%';
            container.appendChild(orb);
            orb.animate([
                { transform: `translate(-50%, -50%) scale(0)`, opacity: 0 },
                { opacity: 1, offset: 0.2 },
                { transform: `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px)) scale(3)`, opacity: 0 }
            ], { duration: 1500, delay: Math.random() * 1000, fill: 'forwards' });
        }
    }

    async function renderCards(results) {
        document.getElementById('gate-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        resultContainer.innerHTML = "";
        resultContainer.style.gridTemplateColumns = results.length === 1 ? "1fr" : "repeat(5, 1fr)";

        for (let item of results) {
            const wrapper = document.createElement('div');
            wrapper.className = "card-wrapper";
            const cardInner = document.createElement('div');
            cardInner.className = "card";
            const back = document.createElement('div');
            back.className = `card-back ${item.rarity === 'ssr' ? 'back-ssr' : (item.rarity === 'sr' ? 'back-sr' : '')}`;
            const front = document.createElement('div');
            front.className = `card-front ${item.rarity}`;
            front.innerHTML = `<div style="font-size: 40px;">${item.icon}</div><div style="font-size: 14px; margin-top: 10px;">${item.rarity.toUpperCase()}</div>${item.isNew ? '<div class="new-badge">NEW!</div>' : ''}`;
            cardInner.appendChild(back); cardInner.appendChild(front);
            wrapper.appendChild(cardInner); resultContainer.appendChild(wrapper);

            await new Promise(r => setTimeout(r, 50));
            wrapper.classList.add('show-wrapper');
            await new Promise(r => setTimeout(r, 100));

            if (item.rarity === "ssr" || item.isNew) {
                canClickToNext = false;
                newOverlay.style.display = 'flex';
                newOverlay.style.pointerEvents = 'auto';
                newOverlay.innerHTML = "";
                if (item.rarity === "ssr") {
                    newOverlay.style.background = "white";
                    const q = document.createElement('div'); q.className='quote-text'; q.style.color="#555"; q.innerText=`„Äå${item.quote}„Äç`;
                    newOverlay.appendChild(q);
                    body.classList.add('super-shake');
                    await new Promise(r => setTimeout(r, 1200));
                    body.classList.remove('super-shake');
                    flashOverlay.classList.add('do-flash');
                    newOverlay.style.background = "rgba(0,0,0,0.95)";
                    q.style.color="white"; q.style.textShadow="0 0 15px gold";
                    newOverlay.innerHTML += `<div class="huge-icon">${item.icon}</div><div style="color:gold; font-size:40px;">SSR</div><div>${item.name}</div><div style="margin-top:20px;">- TOUCH TO CONTINUE -</div>`;
                } else {
                    newOverlay.innerHTML = `<div class="huge-icon">${item.icon}</div><div style="font-size:30px;">${item.rarity.toUpperCase()}</div><div>${item.name}</div><div style="margin-top:20px;">- TOUCH TO CONTINUE -</div>`;
                }
                canClickToNext = true;
                await new Promise(resolve => { resolveGachaWait = resolve; });
            }
            cardInner.classList.add('is-flipped');
        }
    }

    function resumeGacha() { if (canClickToNext) { newOverlay.style.display = 'none'; newOverlay.style.pointerEvents = 'none'; if (resolveGachaWait) resolveGachaWait(); } }
    function toLobby() { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById('lobby-screen').classList.add('active'); }
    function closeSingleCardDisplay() { document.getElementById('single-card-display').style.display = 'none'; }
</script>
</body>
</html>
