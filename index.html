<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚½ã‚·ãƒ£ã‚²é¢¨ã‚¬ãƒãƒ£ï¼ˆæ¼”å‡ºå¼·åŒ–ç‰ˆï¼‰</title>
    <style>
        body { background: #222; color: white; font-family: sans-serif; margin: 0; overflow: hidden; text-align: center; }
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .active { display: flex; }

        button { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 50px; border: none; font-weight: bold; transition: 0.2s; background: white; color: #333; z-index: 10; }
        button:hover { transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .btn-group { display: flex; gap: 20px; margin-top: 20px; }

        /* ãƒ­ãƒ“ãƒ¼èƒŒæ™¯ */
        #lobby-screen { background: radial-gradient(circle, #0042A9, #000); }

        /* --- å¬å–šå¾…æ©Ÿç”»é¢ (Gate) --- */
        #gate-screen { background: black; cursor: pointer; }
        .gate-bg {
            position: absolute; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: transform 1.2s cubic-bezier(0.7, 0, 0.3, 1), filter 1s;
            z-index: 1;
        }
        /* ãƒ©ãƒ³ã‚¯åˆ¥èƒŒæ™¯è¨­å®š */
        .bg-normal { background-image: url('./IMG_2619.jpeg'); }
        .bg-sr { background-image: url('./IMG_SR.jpeg'), linear-gradient(45deg, #f5576c, #f093fb); }
        .bg-ssr { background-image: url('./IMG_SSR.jpeg'), radial-gradient(circle, gold, #ffaa00); }

        .zoom-out-bg { transform: scale(0.1); filter: brightness(5) blur(10px); }

        .gate-text {
            position: relative; z-index: 2; font-size: 32px; font-weight: bold;
            letter-spacing: 5px; animation: pulse 2s infinite; text-shadow: 0 0 20px #00bcd4;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.3; transform: scale(0.95); } 50% { opacity: 1; transform: scale(1.05); } }

        /* çµæœç”»é¢ */
        #result-screen { background: #111; }
        #result-container { display: grid; gap: 15px; margin-bottom: 30px; min-height: 320px; align-items: center; justify-items: center; }

        /* ã‚«ãƒ¼ãƒ‰ã®æ¼”å‡º */
        .card-wrapper { width: 100px; height: 140px; perspective: 600px; opacity: 0; transform: translateY(40px); }
        .show-wrapper { animation: wrapperAppear 0.5s forwards; }
        @keyframes wrapperAppear { to { opacity: 1; transform: translateY(0); } }
        
        .card { width: 100%; height: 100%; position: relative; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .is-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card-back { background: #444; border: 2px solid #666; }
        .card-front { transform: rotateY(180deg); }
        
        .r { border: 1px solid #666; background: #333; }
        .sr { border: 2px solid #f5576c; box-shadow: 0 0 15px #f5576c; background: #442222; }
        .ssr { border: 3px solid gold; box-shadow: 0 0 25px gold; background: #444422; }
        .new-badge { position: absolute; top: -10px; right: -10px; background: #00bcd4; color: white; border-radius: 50%; padding: 5px 8px; font-size: 10px; font-weight: bold; transform: rotate(15deg); z-index: 10; }

        /* ç‰¹æ®Šæ¼”å‡ºãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆè‡ªå‹•é€²è¡Œç”¨ï¼‰ */
        #new-character-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .huge-icon { font-size: 150px; margin-bottom: 20px; filter: drop-shadow(0 0 20px gold); }
        .huge-rarity { font-size: 40px; color: gold; font-style: italic; font-weight: bold; }
        .huge-name { font-size: 30px; margin-top: 10px; border-bottom: 2px solid white; padding-bottom: 10px; }

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; display: none; align-items: center; justify-content: center; z-index: 100; font-size: 32px; font-weight: bold; }
        .ssr-effect { background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff); background-size: 400% 400%; animation: rainbow 1s linear infinite; color: white; }
        @keyframes rainbow { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

        #flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; z-index: 2000; pointer-events: none; }
        .do-flash { animation: flashAnim 0.5s ease-out; }
        @keyframes flashAnim { 0% { opacity: 1; } 100% { opacity: 0; } }

        .quote-text { font-size: 28px; font-style: italic; color: white; text-shadow: 0 0 15px gold; margin-bottom: 20px; animation: quoteIn 0.8s ease-out forwards; }
        @keyframes quoteIn { from { opacity: 0; transform: scale(1.2); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<div id="new-character-overlay" onclick="skipWait()"></div>

<div id="lobby-screen" class="screen active">
    <h1>ä¼èª¬ã®å¬å–š</h1>
    <div class="btn-group">
        <button onclick="prepareGacha(1)">1å›å¬å–š</button>
        <button onclick="prepareGacha(10)" style="background: #ffaa00; color: white;">10å›å¬å–š</button>
    </div>
</div>

<div id="gate-screen" class="screen" onclick="executeGacha()">
    <div id="gate-bg" class="gate-bg bg-normal"></div>
    <div class="gate-text">- TOUCH TO SUMMON -</div>
</div>

<div id="flash-overlay"></div>
<div id="overlay">å¬å–šä¸­...</div>

<div id="result-screen" class="screen">
    <div id="result-container"></div>
    <div class="btn-group">
        <button onclick="toLobby()">æˆ»ã‚‹</button>
        <button id="retry-btn" onclick="prepareGacha(lastCount)" style="background: #ffaa00; color: white;">ã‚‚ã†ä¸€åº¦</button>
    </div>
</div>

<script>
    const resultContainer = document.getElementById('result-container');
    const overlay = document.getElementById('overlay');
    const flashOverlay = document.getElementById('flash-overlay');
    const newOverlay = document.getElementById('new-character-overlay');
    const gateBg = document.getElementById('gate-bg');

    let lastCount = 1;
    let ownedChars = new Set();
    let resolveWait = null;
    let currentPoolResults = [];

    const charData = {
        ssr: [
            { id: "dragon", icon: "ğŸ‰", name: "ç‚ã®ç«œç‹", quote: "æˆ‘ãŒç„”ã«ç„¼ã‘ç„¦ã’ã‚‹ãŒã„ã„ï¼" },
            { id: "queen", icon: "ğŸ‘¸", name: "å…‰ã®å¥³ç‹", quote: "å¸Œæœ›ã®å…‰ã‚ˆã€ä¸–ç•Œã‚’ç…§ã‚‰ã—ã¦ã€‚" }
        ],
        sr: [
            { id: "sword", icon: "âš”ï¸", name: "å‹‡è€…ã®å‰£", quote: "ã“ã®ä¸€æ’ƒã§æ±ºã‚ã‚‹ï¼" },
            { id: "fire", icon: "ğŸ”¥", name: "ç¼ç†±ã®ç²¾éœŠ", quote: "ã‚‚ã£ã¨ç†±ãã—ã¦ã‚„ã‚‹ã‚ˆï¼" }
        ],
        r: [
            { id: "plant", icon: "ğŸŒ¿", name: "è‰åŸã®ç•ªäºº", quote: "é¢¨ãŒå¹ã„ã¦ã„ã‚‹ã­ã€‚" },
            { id: "bone", icon: "ğŸ¦´", name: "å½·å¾¨ã†é­‚", quote: "ç§ã¯ã©ã“ã ..." }
        ]
    };

    function prepareGacha(count) {
        lastCount = count;
        // æŠ½é¸ã‚’å…ˆã«è¡Œã„ã€æœ€é«˜ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚’ç¢ºèªã—ã¦èƒŒæ™¯ã‚’å¤‰ãˆã‚‹
        currentPoolResults = Array.from({length: count}, () => {
            const rand = Math.random();
            const rarity = rand < 0.05 ? "ssr" : (rand < 0.25 ? "sr" : "r");
            const pool = charData[rarity];
            const char = pool[Math.floor(Math.random() * pool.length)];
            const isNew = !ownedChars.has(char.id);
            if (isNew) ownedChars.add(char.id);
            return { ...char, rarity, isNew };
        });

        const topRarity = currentPoolResults.reduce((prev, curr) => {
            if (curr.rarity === "ssr" || prev === "ssr") return "ssr";
            if (curr.rarity === "sr" || prev === "sr") return "sr";
            return "r";
        }, "r");

        // èƒŒæ™¯åˆ‡ã‚Šæ›¿ãˆ
        gateBg.className = "gate-bg";
        if (topRarity === "ssr") gateBg.classList.add("bg-ssr");
        else if (topRarity === "sr") gateBg.classList.add("bg-sr");
        else gateBg.classList.add("bg-normal");

        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('gate-screen').classList.add('active');
    }

    async function executeGacha() {
        gateBg.classList.add('zoom-out-bg');
        await new Promise(r => setTimeout(r, 800));
        flashOverlay.classList.add('do-flash');
        await new Promise(r => setTimeout(r, 400));
        showResults();
    }

    async function showResults() {
        overlay.style.display = "flex";
        overlay.className = "";
        overlay.innerText = "å¬å–šä¸­...";
        
        document.getElementById('gate-screen').classList.remove('active');
        await new Promise(r => setTimeout(r, 800));
        overlay.style.display = "none";
        flashOverlay.classList.remove('do-flash');

        document.getElementById('result-screen').classList.add('active');
        resultContainer.innerHTML = "";
        resultContainer.style.gridTemplateColumns = lastCount === 1 ? "1fr" : "repeat(5, 1fr)";

        for (let item of currentPoolResults) {
            // NEW ã¾ãŸã¯ SSR ã®å ´åˆã¯å¤§ç”»é¢æ¼”å‡ºï¼ˆè‡ªå‹•é€²è¡Œï¼‰
            if (item.isNew || item.rarity === "ssr") {
                await showHugeEffect(item);
            }

            const wrapper = document.createElement('div');
            wrapper.className = "card-wrapper show-wrapper";
            wrapper.innerHTML = `
                <div class="card is-flipped">
                    <div class="card-front ${item.rarity}">
                        <div style="font-size: 40px;">${item.icon}</div>
                        <div style="font-size: 12px;">${item.rarity.toUpperCase()}</div>
                        ${item.isNew ? '<div class="new-badge">NEW!</div>' : ''}
                    </div>
                </div>
            `;
            resultContainer.appendChild(wrapper);
            await new Promise(r => setTimeout(r, 100));
        }
    }

    function showHugeEffect(item) {
        return new Promise(resolve => {
            resolveWait = resolve;
            newOverlay.style.display = "flex";
            newOverlay.innerHTML = `
                <div class="quote-text">ã€Œ${item.quote}ã€</div>
                <div class="huge-icon">${item.icon}</div>
                <div class="huge-rarity">${item.rarity.toUpperCase()}</div>
                <div class="huge-name">${item.name}</div>
                <div style="margin-top:20px; color: #888;">TAP TO SKIP</div>
            `;
            // 3ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            setTimeout(() => skipWait(), 3000);
        });
    }

    function skipWait() {
        if (resolveWait) {
            newOverlay.style.display = "none";
            const tempResolve = resolveWait;
            resolveWait = null;
            tempResolve();
        }
    }

    function toLobby() {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('lobby-screen').classList.add('active');
    }
</script>

</body>
</html>
