<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ソシャゲ風ガチャ</title>
    <style>
        body { background: #222; color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }

        /* --- ガチャTOP --- */
        #lobby-screen { background: #1a2a6c; }
        .btn-group { display: flex; gap: 20px; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 50px; border: none; font-weight: bold; transition: 0.2s; }
        button:hover { transform: scale(1.1); }

        /* --- 結果画面 --- */
        #result-screen { background: #111; }
        #result-container { display: grid; gap: 15px; margin-bottom: 30px; min-height: 300px; align-items: center; }
        /* カードの基本状態 */
    .card {
        width: 100px;
        height: 140px;
        background: #444;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    
        /* 最初は透明で、少し下に配置しておく */
        opacity: 0;
        transform: translateY(30px) scale(0.8);
    }

        /* このクラスがついた瞬間にアニメーション開始 */
    .show-card {
        animation: cardAppear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes cardAppear {
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
        
        /* レアリティ演出 */
        .r { background: #777; }
        .sr { background: #f5576c; border: 2px solid #fff; box-shadow: 0 0 10px #f5576c; }
        .ssr { background: gold; color: black; box-shadow: 0 0 20px gold; animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* 表示アニメーション */
        .show-card { opacity: 1; transform: translateY(0); transition: 0.3s; }

        /* --- 演出オーバーレイ --- */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; display: none; align-items: center; justify-content: center;
            z-index: 100; font-size: 40px; font-weight: bold;
        }
        /* 特殊演出：SR以上がいる時のクラス */
        .rare-effect { color: gold; text-shadow: 0 0 20px gold; animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(0,0); } 50% { transform: translate(3px,3px); } 100% { transform: translate(-3px,-3px); } }
    </style>
</head>
<body>

<div id="lobby-screen" class="screen active">
    <h1>召喚</h1>
    <div class="btn-group">
        <button onclick="startGacha(1)">1回召喚</button>
        <button onclick="startGacha(10)" style="background: #ffaa00;">10回召喚</button>
    </div>
</div>

<div id="overlay">召喚中...</div>

<div id="result-screen" class="screen">
    <div id="result-container"></div>
    <div class="btn-group">
        <button onclick="toLobby()">戻る</button>
        <button id="retry-btn" onclick="startGacha(lastCount)" style="background: #ffaa00;">もう一度引く</button>
    </div>
</div>

<script>
    const lobbyScreen = document.getElementById('lobby-screen');
    const resultScreen = document.getElementById('result-screen');
    const resultContainer = document.getElementById('result-container');
    const overlay = document.getElementById('overlay');
    const retryBtn = document.getElementById('retry-btn');

    let lastCount = 1; // 直前に引いた回数を保存

    async function startGacha(count) {
        lastCount = count;
        
        // 1. 結果の計算
        const results = [];
        let hasRare = false; // SR以上があるかフラグ
        const rates = { ssr: 0.03, sr: 0.17 };

        for (let i = 0; i < count; i++) {
            const rand = Math.random();
            let rarity = "r";
            if (rand < rates.ssr) { rarity = "ssr"; hasRare = true; }
            else if (rand < rates.ssr + rates.sr) { rarity = "sr"; hasRare = true; }
            results.push(rarity);
        }

        // 2. 演出フェーズ
        overlay.innerText = "召喚中...";
        overlay.classList.remove('rare-effect');
        overlay.style.display = "flex";

        await new Promise(r => setTimeout(r, 800)); // 少し待機

        // 【B：特殊演出】SR以上があれば文字が豪華に！
        if (hasRare) {
            overlay.innerText = "高エネルギー反応！";
            overlay.classList.add('rare-effect');
            await new Promise(r => setTimeout(r, 1200)); 
        } else {
            await new Promise(r => setTimeout(r, 500));
        }

        // 3. 画面切り替え
        overlay.style.display = "none";
        lobbyScreen.classList.remove('active');
        resultScreen.classList.add('active');
        
        resultContainer.innerHTML = "";
        resultContainer.style.gridTemplateColumns = count === 1 ? "1fr" : "repeat(5, 1fr)";
        retryBtn.innerText = `もう一度(${count}回)引く`;

        // 4. カードを順番に表示
        for (const rarity of results) {
             const card = document.createElement('div');
             card.className = `card ${rarity}`;
             card.innerText = rarity.toUpperCase();
             resultContainer.appendChild(card);
    
        // ブラウザに描画を促すため、少しだけ待ってからクラスを付与
        await new Promise(r => setTimeout(r, 10)); 
        card.classList.add('show-card');
    
        // 次のカードが出るまでの待機時間
        await new Promise(r => setTimeout(r, 1500 / count));
    }
        }
    }

    function toLobby() {
        resultScreen.classList.remove('active');
        lobbyScreen.classList.add('active');
    }
</script>

</body>
</html>
